{% extends "base.html" %}

{% block title %}{{ campaign.name }}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto" id="main-content">
    <!-- Breadcrumb -->
    <div class="mb-4">
        <a href="/dashboard" class="text-gray-400 hover:text-white text-sm">&larr; Dashboard</a>
    </div>

    <!-- Campaign header -->
    <div class="campaign-accent bg-gray-800 rounded-lg p-4 sm:p-6 mb-6" style="--campaign-colour: {{ campaign.colour }}">
        <div class="flex items-center justify-between mb-2">
            <h2 class="text-xl sm:text-2xl font-bold text-white">{{ campaign.name }}</h2>
            <div class="flex items-center gap-2">
                <span class="w-2.5 h-2.5 rounded-full health-{{ health }}"></span>
                <button hx-get="/partials/campaign-form?id={{ campaign.id }}"
                        hx-target="#modal-container"
                        class="text-gray-400 hover:text-white text-sm min-h-[44px] min-w-[44px] flex items-center justify-center">Edit</button>
            </div>
        </div>
        <p class="text-gray-400 text-sm">{{ campaign.description }}</p>
        <div class="flex flex-wrap gap-x-6 gap-y-1 mt-4 text-sm text-gray-400">
            <span>Priority: #{{ campaign.priority_rank }}</span>
            <span>Target: {{ campaign.weekly_block_target }} blocks/week</span>
            {% if campaign.target_date %}
            <span>Due: {{ campaign.target_date }}</span>
            {% endif %}
        </div>
    </div>

    <!-- Bulk actions bar (hidden until checkboxes are ticked) -->
    <div id="bulk-actions" class="hidden bg-gray-800 border border-gray-700 rounded-lg p-3 mb-4 flex flex-wrap items-center gap-3">
        <span class="text-sm text-gray-300"><span id="bulk-count">0</span> selected</span>
        <button onclick="bulkAction('completed')" class="px-3 py-1.5 bg-green-700 hover:bg-green-600 text-white text-sm rounded">Complete</button>
        <button onclick="bulkAction('abandoned')" class="px-3 py-1.5 bg-red-700 hover:bg-red-600 text-white text-sm rounded">Abandon</button>
        <button onclick="clearBulkSelection()" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 text-white text-sm rounded">Cancel</button>
    </div>

    <!-- Missions -->
    <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-white">Missions</h3>
        <button hx-get="/partials/mission-form?campaign_id={{ campaign.id }}"
                hx-target="#modal-container"
                class="px-3 py-2 bg-gray-700 hover:bg-gray-600 text-white text-sm rounded-lg min-h-[44px]">
            + Mission
        </button>
    </div>

    <div id="missions-list" class="space-y-4">
        {% for mission in missions %}
        <div class="bg-gray-800 rounded-lg p-4">
            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-2 mb-3">
                <div class="flex items-center gap-2 min-w-0">
                    <span class="text-sm px-2 py-0.5 rounded-full shrink-0
                        {% if mission.status.value == 'completed' %}bg-green-900 text-green-300
                        {% elif mission.status.value == 'in_progress' %}bg-blue-900 text-blue-300
                        {% elif mission.status.value == 'blocked' %}bg-red-900 text-red-300
                        {% else %}bg-gray-700 text-gray-300{% endif %}">
                        {{ mission.status.value | replace('_', ' ') | title }}
                    </span>
                    <h4 class="font-medium text-white truncate">{{ mission.name }}</h4>
                </div>
                <div class="flex items-center gap-2 shrink-0">
                    <button hx-get="/partials/sortie-form?mission_id={{ mission.id }}"
                            hx-target="#modal-container"
                            class="text-gray-400 hover:text-white text-sm px-2 py-1 min-h-[44px] flex items-center">+ Sortie</button>
                    <button hx-get="/partials/mission-form?id={{ mission.id }}&campaign_id={{ campaign.id }}"
                            hx-target="#modal-container"
                            class="text-gray-400 hover:text-white text-sm px-2 py-1 min-h-[44px] flex items-center">Edit</button>
                </div>
            </div>

            {% if mission.description %}
            <p class="text-gray-400 text-sm mb-3">{{ mission.description }}</p>
            {% endif %}

            <!-- Sorties within this mission -->
            <div class="space-y-2" id="sorties-{{ mission.id }}">
                {% for sortie in mission.sorties | sort(attribute='sort_order') %}
                {% include "partials/sortie_row.html" %}
                {% endfor %}
            </div>
        </div>
        {% endfor %}

        {% if not missions %}
        <p class="text-gray-400 text-center py-8">No missions yet. Add a mission to start planning.</p>
        {% endif %}
    </div>
</div>

<script>
function updateBulkBar() {
    var checked = document.querySelectorAll('.sortie-checkbox:checked');
    var bar = document.getElementById('bulk-actions');
    var count = document.getElementById('bulk-count');
    if (checked.length > 0) {
        bar.classList.remove('hidden');
        count.textContent = checked.length;
    } else {
        bar.classList.add('hidden');
    }
}

function bulkAction(status) {
    var checked = document.querySelectorAll('.sortie-checkbox:checked');
    var ids = [];
    checked.forEach(function(cb) { ids.push(cb.dataset.sortieId); });
    if (ids.length === 0) return;

    var apiKey = document.querySelector('meta[name="api-key"]')?.content || '';
    fetch('/api/v1/sorties/bulk', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-API-Key': apiKey,
        },
        body: JSON.stringify({ ids: ids, status: status }),
    }).then(function(response) {
        if (response.ok) {
            window.location.reload();
        }
    });
}

function clearBulkSelection() {
    document.querySelectorAll('.sortie-checkbox').forEach(function(cb) {
        cb.checked = false;
    });
    updateBulkBar();
}
</script>
{% endblock %}
